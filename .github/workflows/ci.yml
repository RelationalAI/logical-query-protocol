name: CI Tests

on:
  push:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        python-version: ["3.10", "3.11"]

    env:
      UV_PYTHON: ${{ matrix.python-version }}

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Lint
      run: |
        cd sdks/python
        uv run ruff check
        uv run ruff format --check

    - name: Lint meta
      run: |
        cd meta
        uv run ruff check
        uv run ruff format --check

    - name: Test meta with pytest
      run: |
        cd meta
        uv run python -m pytest

    - name: Type check meta
      run: |
        cd meta
        uv run pyrefly check

    - name: Run tests
      run: |
        cd sdks/python
        uv run python -m pytest

    - name: Type check
      run: |
        cd sdks/python
        uv run pyrefly check

  julia-test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        julia-version: ["1.10", "1.11", "1.12"]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Julia ${{ matrix.julia-version }}
      uses: julia-actions/setup-julia@v2
      with:
        version: ${{ matrix.julia-version }}

    - name: Sync test data
      run: |
        mkdir -p sdks/julia/LogicalQueryProtocol/test/lqp sdks/julia/LogicalQueryProtocol/test/pretty sdks/julia/LogicalQueryProtocol/test/bin
        cp tests/lqp/*.lqp sdks/julia/LogicalQueryProtocol/test/lqp/
        cp tests/pretty/*.lqp sdks/julia/LogicalQueryProtocol/test/pretty/
        cp tests/bin/*.bin sdks/julia/LogicalQueryProtocol/test/bin/

    - name: Run tests
      run: |
        cd sdks/julia/LogicalQueryProtocol
        julia --project=. -e 'using Pkg; Pkg.instantiate(); Pkg.test()'

  go-test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        go-version: ["1.25"]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25'

    - name: Run tests
      run: |
        cd sdks/go
        go test -v ./test/...
