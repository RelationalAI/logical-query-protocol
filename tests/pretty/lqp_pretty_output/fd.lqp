(transaction
  (configure { :ivm.maintenance_level "off" :semantics_version 0})
  (epoch
    (writes
      (define
        (fragment
          :person_model
          (def :Person ([id::INT] (or (= id 1) (= id 2))))
          (def
            :ssn
            ([id::INT n::STRING]
             (or (and (= id 1) (= n "SSN#Alice")) (and (= id 2) (= n "SSN#Bob"))))
            (attrs (attribute :function "checked")))
          (functional_dependency
            :ssn_is_person_key
            ([n::STRING id::INT] (atom :ssn id n))
            (keys n)
            (values id))
          (def
            :first_name
            ([id::INT fn::STRING]
             (or (and (= id 1) (= fn "Alice")) (and (= id 2) (= fn "Bob"))))
            (attrs (attribute :function "checked")))
          (def
            :last_name
            ([id::INT ln::STRING]
             (or (and (= id 1) (= ln "Smith")) (and (= id 2) (= ln "Johnson"))))
            (attrs (attribute :function "checked")))
          (functional_dependency
            :name_is_person_key
            ([fn::STRING ln::STRING id::INT]
             (and (atom :first_name id fn) (atom :last_name id ln)))
            (keys fn ln)
            (values id))))
      (define
        (fragment
          :emp_model
          (def :Employee ([id::INT] (= id 1)))
          (def
            :emp_id
            ([id::INT eid::INT] (and (= id 1) (= eid 1001)))
            (attrs (attribute :function "checked")))
          (functional_dependency
            :ssn_is_employee_key
            ([n::STRING id::INT] (atom :ssn id n))
            (keys n)
            (values id))
          (functional_dependency
            :emp_id_is_employee_key
            ([eid::INT id::INT] (atom :emp_id id eid))
            (keys eid)
            (values id))))
      (define
        (fragment
          :query1
          (def
            :query1
            ([n::STRING fn::STRING ln::STRING eid::INT]
             (exists
               [person_id::INT]
               (and
                 (atom :ssn person_id n)
                 (atom :first_name person_id fn)
                 (atom :last_name person_id ln)
                 (atom :emp_id person_id eid)
                 (atom :Employee person_id))))))))
    (reads (output :output1 :query1)))
  (epoch
    (writes
      (define
        (fragment
          :car_model
          (def :Car ([id::INT] (or (= id 3) (= id 4))))
          (def
            :vin
            ([id::INT v::STRING]
             (or (and (= id 3) (= v "VIN#Honda")) (and (= id 4) (= v "VIN#Toyota"))))
            (attrs (attribute :function "checked")))
          (functional_dependency
            :vin_is_car_key
            ([v::STRING id::INT] (atom :vin id v))
            (keys v)
            (values id))
          (def
            :make
            ([id::INT m::STRING]
             (or (and (= id 3) (= m "Honda")) (and (= id 4) (= m "Toyota"))))
            (attrs (attribute :function "checked")))
          (def
            :purchased_on_for
            ([person_id::INT car_id::INT date::STRING amount::INT]
             (or
               (and (= person_id 1) (= car_id 3) (= date "2020-01-15") (= amount 20000))
               (and (= person_id 2) (= car_id 4) (= date "2021-06-30") (= amount 25000))))
            (attrs (attribute :function "checked" 2)))))))
  (epoch
    (writes
      (define
        (fragment
          :car_purchase_fd
          (functional_dependency
            :date_and_car_determine_person
            ([person_id::INT car_id::INT date::STRING amount::INT]
             (atom :purchased_on_for person_id car_id date amount))
            (keys car_id date)
            (values person_id))))
      (define
        (fragment
          :ownership_model
          (def
            :owns
            ([person_id::INT car_id::INT]
             (exists
               [date::STRING amount::INT]
               (and (atom :purchased_on_for person_id car_id date amount) (>= amount 20000)))))
          (functional_dependency
            :car_determines_owner
            ([person_id::INT car_id::INT]
             (and (atom :owns person_id car_id) (atom :Person person_id)))
            (keys person_id)
            (values car_id))))))
  (epoch
    (writes
      (define
        (fragment
          :ownership_model
          (def
            :owns
            ([person_id::INT car_id::INT]
             (exists
               [date::STRING amount::INT]
               (atom :purchased_on_for person_id car_id date amount))))
          (functional_dependency
            :car_has_at_most_one_owner
            ([person_id::INT car_id::INT] (atom :owns person_id car_id))
            (keys car_id)
            (values person_id))))
      (undefine :emp_model)))
  (epoch
    (writes
      (define
        (fragment
          :query2
          (functional_dependency
            :vin_determines_owner
            ([n::STRING car_id::INT person_id::INT v::STRING]
             (and
               (atom :ssn person_id n)
               (atom :vin car_id v)
               (atom :owns person_id car_id)))
            (keys v)
            (values n))
          (def
            :query2
            ([n::STRING fn::STRING ln::STRING v::STRING]
             (exists
               [person_id::INT car_id::INT]
               (and
                 (atom :ssn person_id n)
                 (atom :first_name person_id fn)
                 (atom :last_name person_id ln)
                 (atom :owns person_id car_id)
                 (atom :vin car_id v))))))))
    (reads (output :output2 :query2))))
