(transaction
  (configure
    { :ivm.maintenance_level "off"
      :semantics_version 0})
  (epoch
    (writes
      (define
        (fragment :f1
          (def :users
            ([id::INT name::STRING score::FLOAT]
              (or
                (and
                  (primitive :rel_primitive_eq id 100)
                  (primitive :rel_primitive_eq name "Alice")
                  (primitive :rel_primitive_eq score 95.5))
                (and
                  (primitive :rel_primitive_eq id 200)
                  (primitive :rel_primitive_eq name "Bob")
                  (primitive :rel_primitive_eq score 87.3)))))
          (def :products
            ([id::INT name::STRING price::(DECIMAL 10 2) active::BOOLEAN]
              (or
                (and
                  (primitive :rel_primitive_eq id 1)
                  (primitive :rel_primitive_eq name "Widget")
                  (primitive :rel_primitive_eq price 19.99)
                  (primitive :rel_primitive_eq active true))
                (and
                  (primitive :rel_primitive_eq id 2)
                  (primitive :rel_primitive_eq name "Gadget")
                  (primitive :rel_primitive_eq price 29.5)
                  (primitive :rel_primitive_eq active false)))))
          (def :events
            ([event_id::INT timestamp::DATETIME description::STRING]
              (or
                (and
                  (primitive :rel_primitive_eq event_id 1)
                  (primitive :rel_primitive_eq timestamp (datetime 2025 1 1 10 30 0 0))
                  (primitive :rel_primitive_eq description "Start"))
                (and
                  (primitive :rel_primitive_eq event_id 2)
                  (primitive :rel_primitive_eq timestamp (datetime 2025 1 2 14 45 0 0))
                  (primitive :rel_primitive_eq description "End")))))
          (def :simple
            ([key::STRING value::INT]
              (or
                (and
                  (primitive :rel_primitive_eq key "a")
                  (primitive :rel_primitive_eq value 1))
                (and
                  (primitive :rel_primitive_eq key "b")
                  (primitive :rel_primitive_eq value 2)))))
          (def :names
            ([name::STRING]
              (or
                (primitive :rel_primitive_eq name "Alice")
                (primitive :rel_primitive_eq name "Bob")
                (primitive :rel_primitive_eq name "Carol"))))
          (def :col_id
            ([row::INT v::INT]
              (or
                (and
                  (primitive :rel_primitive_eq row 1)
                  (primitive :rel_primitive_eq v 100))
                (and
                  (primitive :rel_primitive_eq row 2)
                  (primitive :rel_primitive_eq v 200))
                (and
                  (primitive :rel_primitive_eq row 3)
                  (primitive :rel_primitive_eq v 300)))))
          (def :col_name
            ([row::INT v::STRING]
              (or
                (and
                  (primitive :rel_primitive_eq row 1)
                  (primitive :rel_primitive_eq v "Alice"))
                (and
                  (primitive :rel_primitive_eq row 2)
                  (primitive :rel_primitive_eq v "Bob"))
                (and
                  (primitive :rel_primitive_eq row 3)
                  (primitive :rel_primitive_eq v "Carol")))))
          (def :col_score
            ([row::INT v::FLOAT]
              (or
                (and
                  (primitive :rel_primitive_eq row 1)
                  (primitive :rel_primitive_eq v 95.5))
                (and
                  (primitive :rel_primitive_eq row 2)
                  (primitive :rel_primitive_eq v 87.3))
                (and
                  (primitive :rel_primitive_eq row 3)
                  (primitive :rel_primitive_eq v 92.0)))))
          (def :col_active
            ([row::INT v::BOOLEAN]
              (or
                (and
                  (primitive :rel_primitive_eq row 1)
                  (primitive :rel_primitive_eq v true))
                (and
                  (primitive :rel_primitive_eq row 2)
                  (primitive :rel_primitive_eq v false))
                (and
                  (primitive :rel_primitive_eq row 3)
                  (primitive :rel_primitive_eq v true))))))))
    (reads
      (export
        (export_csv_config_v2
          (path "users_basic.csv")
          (table_def
            :users)
          (csv_config
            { :csv_compression "auto"
              :csv_decimal_separator "."
              :csv_delimiter ","
              :csv_encoding "utf-8"
              :csv_escapechar "\""
              :csv_header_row 1
              :csv_quotechar "\""
              :csv_skip 0})))
      (export
        (export_csv_config_v2
          (path "users_pipe.csv")
          (table_def
            :users)
          (csv_config
            { :csv_compression "auto"
              :csv_decimal_separator "."
              :csv_delimiter "|"
              :csv_encoding "utf-8"
              :csv_escapechar "\\"
              :csv_header_row 1
              :csv_quotechar "\""
              :csv_skip 0})))
      (export
        (export_csv_config_v2
          (path "users_compressed.csv.gz")
          (table_def
            :users)
          (csv_config
            { :csv_compression "gzip"
              :csv_decimal_separator "."
              :csv_delimiter ","
              :csv_encoding "utf-8"
              :csv_escapechar "\\"
              :csv_header_row 1
              :csv_partition_size_mb 1000
              :csv_quotechar "\""
              :csv_skip 0})))
      (export
        (export_csv_config_v2
          (path "products.csv")
          (table_def
            :products)
          (csv_config
            { :csv_compression "auto"
              :csv_decimal_separator "."
              :csv_delimiter ","
              :csv_encoding "utf-8"
              :csv_escapechar "\\"
              :csv_header_row 1
              :csv_quotechar "\""
              :csv_skip 0})))
      (export
        (export_csv_config_v2
          (path "events.csv")
          (table_def
            :events)
          (csv_config
            { :csv_compression "auto"
              :csv_decimal_separator "."
              :csv_delimiter ","
              :csv_encoding "utf-8"
              :csv_escapechar "\\"
              :csv_header_row 1
              :csv_quotechar "\""
              :csv_skip 0})))
      (export
        (export_csv_config_v2
          (path "users.tsv")
          (table_def
            :users)
          (csv_config
            { :csv_compression "auto"
              :csv_decimal_separator "."
              :csv_delimiter "\t"
              :csv_encoding "utf-8"
              :csv_escapechar "\\"
              :csv_header_row 1
              :csv_quotechar "\""
              :csv_skip 0})))
      (export
        (export_csv_config_v2
          (path "simple_no_header.csv")
          (table_def
            :simple)
          (csv_config
            { :csv_compression "auto"
              :csv_decimal_separator "."
              :csv_delimiter ","
              :csv_encoding "utf-8"
              :csv_escapechar "\\"
              :csv_header_row 0
              :csv_quotechar "\""
              :csv_skip 0})))
      (export
        (export_csv_config_v2
          (path "names_only.csv")
          (table_def
            :names)
          (csv_config
            { :csv_compression "auto"
              :csv_decimal_separator "."
              :csv_delimiter ","
              :csv_encoding "utf-8"
              :csv_escapechar "\""
              :csv_header_row 1
              :csv_quotechar "\""
              :csv_skip 0})))
      (export
        (export_csv_config_v2
          (path "gnf_all_columns.csv")
          (gnf_columns
            (column "id" :col_id)
            (column "name" :col_name)
            (column "score" :col_score)
            (column "active" :col_active))
          (csv_config
            { :csv_compression "auto"
              :csv_decimal_separator "."
              :csv_delimiter ","
              :csv_encoding "utf-8"
              :csv_escapechar "\\"
              :csv_header_row 1
              :csv_quotechar "\""
              :csv_skip 0})))
      (export
        (export_csv_config_v2
          (path "gnf_subset.csv")
          (gnf_columns
            (column "user_id" :col_id)
            (column "user_name" :col_name))
          (csv_config
            { :csv_compression "auto"
              :csv_decimal_separator "."
              :csv_delimiter ","
              :csv_encoding "utf-8"
              :csv_escapechar "\\"
              :csv_header_row 1
              :csv_quotechar "\""
              :csv_skip 0})))
      (export
        (export_csv_config_v2
          (path "gnf_custom.csv.gz")
          (gnf_columns
            (column "id" :col_id)
            (column "score" :col_score))
          (csv_config
            { :csv_compression "auto"
              :csv_decimal_separator "."
              :csv_delimiter ","
              :csv_encoding "utf-8"
              :csv_escapechar "\""
              :csv_header_row 1
              :csv_quotechar "\""
              :csv_skip 0})))
      (export
        (export_csv_config_v2
          (path "gnf_single.csv")
          (gnf_columns
            (column "score" :col_score))
          (csv_config
            { :csv_compression "auto"
              :csv_decimal_separator "."
              :csv_delimiter ","
              :csv_encoding "utf-8"
              :csv_escapechar "\""
              :csv_header_row 1
              :csv_quotechar "\""
              :csv_skip 0}))))))
