(transaction
    (epoch
        (local_writes
            (define
                (fragment :f1
                    ;; def common(_lineitem, _lineitem_l_returnflag, _lineitem_l_linestatus):
                    ;;     exists((_lineitem_l_shipdate) |
                    ;;         LineItem(_lineitem) and
                    ;;         l_shipdate(_lineitem, _lineitem_l_shipdate) and
                    ;;         l_returnflag(_lineitem, _lineitem_l_returnflag) and
                    ;;         l_linestatus(_lineitem, _lineitem_l_linestatus) and
                    ;;         _lineitem_l_shipdate <= 1998-09-02
                    ;;     )
                    (def :common
                        (
                            [_lineitem::UINT128
                             _lineitem_l_returnflag::STRING
                             _lineitem_l_linestatus::STRING]

                            (exists [_lineitem_l_shipdate::DATE _date_limit::DATE]
                                (and
                                    (relatom :LineItem _lineitem::UINT128)
                                    (relatom :lqp_l_shipdate _lineitem::UINT128 _lineitem_l_shipdate::DATE)
                                    (relatom :lqp_l_returnflag _lineitem::UINT128 _lineitem_l_returnflag::STRING)
                                    (relatom :lqp_l_linestatus _lineitem::UINT128 _lineitem_l_linestatus::STRING)

                                    ;; We don't have date literals in LQP, so we need to get
                                    ;; the date limit from a relatom
                                    (relatom :lqp_date_limit _date_limit::DATE)
                                    (<= _lineitem_l_shipdate::DATE _date_limit::DATE)))))

                    ;; def sum_qty(_lineitem_l_returnflag, _lineitem_l_linestatus, _v):
                    ;;     std::common::sum(
                    ;;         {(_lineitem, _lineitem_l_quantity):
                    ;;             common(_lineitem, _lineitem_l_returnflag, _lineitem_l_linestatus) and
                    ;;             l_quantity(_lineitem, _lineitem_l_quantity)
                    ;;         },
                    ;;         _v
                    ;;     )
                    (def :sum_qty
                        (
                            [_lineitem_l_returnflag::STRING
                             _lineitem_l_linestatus::STRING
                             _v::DECIMAL ]

                            (reduce
                                ([a::DECIMAL b::DECIMAL c::DECIMAL] (+ a::DECIMAL b::DECIMAL c::DECIMAL))   ;; op
                                ([_lineitem::UINT128 _lineitem_l_quantity::DECIMAL]      ;; body
                                    (and
                                        (atom
                                            :common
                                            _lineitem::UINT128
                                            _lineitem_l_returnflag::STRING
                                            _lineitem_l_linestatus::STRING)
                                        (relatom
                                            :lqp_l_quantity
                                            _lineitem::UINT128
                                            _lineitem_l_quantity::DECIMAL)))
                                (terms _v::DECIMAL))))

                    ;; def sum_base_price(_lineitem_l_returnflag, _lineitem_l_linestatus, _v):
                    ;;     std::common::sum(
                    ;;         {(_lineitem, _lineitem_l_extendedprice):
                    ;;             common(_lineitem, _lineitem_l_returnflag, _lineitem_l_linestatus) and
                    ;;             l_extendedprice(_lineitem, _lineitem_l_extendedprice)
                    ;;         },
                    ;;         _v
                    ;;     )
                    (def :sum_base_price
                        (
                            [_lineitem_l_returnflag::STRING
                             _lineitem_l_linestatus::STRING
                             _v::DECIMAL ]

                            (reduce
                                ([a::DECIMAL b::DECIMAL c::DECIMAL] (+ a::DECIMAL b::DECIMAL c::DECIMAL))   ;; op
                                ([_lineitem::UINT128 _lineitem_l_extendedprice::DECIMAL] ;; body
                                    (and
                                        (atom
                                            :common
                                            _lineitem::UINT128
                                            _lineitem_l_returnflag::STRING
                                            _lineitem_l_linestatus::STRING)
                                        (relatom
                                            :lqp_l_extendedprice
                                            _lineitem::UINT128
                                            _lineitem_l_extendedprice::DECIMAL)))
                                (terms _v::DECIMAL))))

                    ;; def sum_disc_price(_lineitem_l_returnflag, _lineitem_l_linestatus, _v):
                    ;;     std::common::sum(
                    ;;         {(_lineitem, _disc_price):
                    ;;             exists((_lineitem_l_discount, _lineitem_l_extendedprice) |
                    ;;                 common(_lineitem, _lineitem_l_returnflag, _lineitem_l_linestatus) and
                    ;;                 l_discount(_lineitem, _lineitem_l_discount) and
                    ;;                 l_extendedprice(_lineitem, _lineitem_l_extendedprice) and
                    ;;                 _disc_price = _lineitem_l_extendedprice * (1 - _lineitem_l_discount)
                    ;;             )
                    ;;         },
                    ;;         _v
                    ;;     )
                    (def :sum_disc_price
                        (
                            [_lineitem_l_returnflag::STRING
                             _lineitem_l_linestatus::STRING
                             _v::DECIMAL]

                            (reduce
                                ([a::DECIMAL b::DECIMAL c::DECIMAL] (+ a::DECIMAL b::DECIMAL c::DECIMAL))   ;; op
                                ([_lineitem::UINT128 _disc_price::DECIMAL]              ;; body
                                    (exists
                                        [_lineitem_l_discount::DECIMAL
                                         _lineitem_l_extendedprice::DECIMAL
                                         _disc_perc::DECIMAL]

                                        (and
                                            (atom
                                                :common
                                                _lineitem::UINT128
                                                _lineitem_l_returnflag::STRING
                                                _lineitem_l_linestatus::STRING)
                                            (relatom
                                                :lqp_l_discount
                                                _lineitem::UINT128
                                                _lineitem_l_discount::DECIMAL)
                                            (relatom
                                                :lqp_l_extendedprice
                                                _lineitem::UINT128
                                                _lineitem_l_extendedprice::DECIMAL)
                                            (+ _lineitem_l_extendedprice::DECIMAL _disc_perc::DECIMAL _disc_price::DECIMAL)
                                            ;; 10000 is the physical int of 1 as a decimal(64, 4)
                                            (exists [_one::DECIMAL]
                                                (and
                                                    (cast DECIMAL 1 _one::DECIMAL)
                                                    (- _one::DECIMAL _lineitem_l_discount::DECIMAL _disc_perc::DECIMAL))))))
                                (terms _v::INT))))

                    ;; def sum_charge(_lineitem_l_returnflag, _lineitem_l_linestatus, _v):
                    ;;     std::common::sum(
                    ;;         {(_lineitem, _charge):
                    ;;             exists((_lineitem_l_extendedprice, _lineitem_l_discount, _lineitem_l_tax, _disc_perc, _disc_price) |
                    ;;                 common(_lineitem, _lineitem_l_returnflag, _lineitem_l_linestatus) and
                    ;;                 l_extendedprice(_lineitem, _lineitem_l_extendedprice) and
                    ;;                 l_discount(_lineitem, _lineitem_l_discount) and
                    ;;                 l_tax(_lineitem, _lineitem_l_tax) and
                    ;;                 _disc_price = _lineitem_l_extendedprice * (1 - _lineitem_l_discount) and
                    ;;                 _charge = _disc_price * (1 + l_tax)
                    ;;             )
                    ;;         },
                    ;;         _v
                    ;;     )
                    (def :sum_charge
                        (
                            [_lineitem_l_returnflag::STRING
                             _lineitem_l_linestatus::STRING
                             _v::DECIMAL]

                            (reduce
                                ([a::DECIMAL b::DECIMAL c::DECIMAL] (+ a::DECIMAL b::DECIMAL c::DECIMAL))   ;; op
                                ([_lineitem::UINT128 _charge::DECIMAL]                  ;; body
                                    (exists
                                        [_lineitem_l_extendedprice::DECIMAL
                                         _lineitem_l_discount::DECIMAL
                                         _lineitem_l_tax::DECIMAL
                                         _disc_perc::DECIMAL
                                         _disc_price::DECIMAL
                                         _tax_rate::DECIMAL
                                         _one::DECIMAL]

                                        (and
                                            (atom
                                                :common
                                                _lineitem::UINT128
                                                _lineitem_l_returnflag::STRING
                                                _lineitem_l_linestatus::STRING)
                                            (relatom
                                                :lqp_l_extendedprice
                                                _lineitem::UINT128
                                                _lineitem_l_extendedprice::DECIMAL)
                                            (relatom
                                                :lqp_l_discount
                                                _lineitem::UINT128
                                                _lineitem_l_discount::DECIMAL)
                                            (relatom
                                                :lqp_l_tax
                                                _lineitem::UINT128
                                                _lineitem_l_tax::DECIMAL)
                                            (cast DECIMAL 1 _one::DECIMAL)
                                            (* _lineitem_l_extendedprice::DECIMAL _disc_perc::DECIMAL _disc_price::DECIMAL)
                                            (- _one::DECIMAL _lineitem_l_discount::DECIMAL _disc_perc::DECIMAL)
                                            (* _disc_price::DECIMAL _tax_rate::DECIMAL _charge::DECIMAL)
                                            (+ _one::DECIMAL _lineitem_l_tax::DECIMAL _tax_rate::DECIMAL))))
                                (terms _v::INT))))

                    ;; def avg_qty(_lineitem_l_returnflag, _lineitem_l_linestatus, _v):
                    ;;     std::common::mean(
                    ;;         {(_lineitem, _lineitem_l_quantity):
                    ;;             common(_lineitem, _lineitem_l_returnflag, _lineitem_l_linestatus) and
                    ;;             l_quantity(_lineitem, _lineitem_l_quantity)
                    ;;         },
                    ;;         _v
                    ;;     )
                    (def :avg_qty
                        (
                            [_lineitem_l_returnflag::STRING
                             _lineitem_l_linestatus::STRING
                             _v::DECIMAL]

                            (exists [_sum_qty::DECIMAL _count_qty::DECIMAL]
                                (and
                                    (atom :sum_qty _lineitem_l_returnflag::STRING _lineitem_l_linestatus::STRING _sum_qty::DECIMAL)
                                    (reduce
                                        ([a::DECIMAL b::DECIMAL c::DECIMAL] (+ a::DECIMAL b::DECIMAL c::DECIMAL))   ;; op
                                        ([_lineitem::UINT128 _lineitem_l_quantity::DECIMAL _one::DECIMAL]      ;; body
                                            (and
                                                (atom
                                                    :common
                                                    _lineitem::UINT128
                                                    _lineitem_l_returnflag::STRING
                                                    _lineitem_l_linestatus::STRING)
                                                (relatom
                                                    :lqp_l_quantity
                                                    _lineitem::UINT128
                                                    _lineitem_l_quantity::DECIMAL)
                                                ;; TODO: we probably should be counting with INT and casting to decimal, but this works for now
                                                (cast DECIMAL 1 _one::DECIMAL)))
                                        (terms _count_qty::INT))
                                    (/ _sum_qty::DECIMAL _count_qty::DECIMAL _v::DECIMAL)))))

                    ;; def avg_base_price(_lineitem_l_returnflag, _lineitem_l_linestatus, _v):
                    ;;     std::common::mean(
                    ;;         {(_lineitem, _lineitem_l_extendedprice):
                    ;;             common(_lineitem, _lineitem_l_returnflag, _lineitem_l_linestatus) and
                    ;;             l_extendedprice(_lineitem, _lineitem_l_extendedprice)
                    ;;         },
                    ;;         _v
                    ;;     )
                    (def :avg_base_price
                        (
                            [_lineitem_l_returnflag::STRING
                             _lineitem_l_linestatus::STRING
                             _v::DECIMAL]

                            (exists [_sum_base_price::DECIMAL _count_base_price::DECIMAL]
                                (and
                                    (atom :sum_base_price _lineitem_l_returnflag::STRING _lineitem_l_linestatus::STRING _sum_base_price::DECIMAL)
                                    (reduce
                                        ([a::DECIMAL b::DECIMAL c::DECIMAL] (+ a::DECIMAL b::DECIMAL c::DECIMAL))   ;; op
                                        ([_lineitem::UINT128 _lineitem_l_extendedprice::DECIMAL _one::DECIMAL]      ;; body
                                            (and
                                                (atom
                                                    :common
                                                    _lineitem::UINT128
                                                    _lineitem_l_returnflag::STRING
                                                    _lineitem_l_linestatus::STRING)
                                                (relatom
                                                    :lqp_l_extendedprice
                                                    _lineitem::UINT128
                                                    _lineitem_l_extendedprice::DECIMAL)
                                                ;; TODO: we probably should be counting with INT and casting to decimal, but this works for now
                                                (cast DECIMAL 1 _one::DECIMAL)))
                                        (terms _count_base_price::INT))
                                    (/ _sum_base_price::DECIMAL _count_base_price::DECIMAL _v::DECIMAL)))))

                    ;; def avg_disc(_lineitem_l_returnflag, _lineitem_l_linestatus, _v):
                    ;;     std::common::mean(
                    ;;         {(_lineitem, _lineitem_l_discount):
                    ;;             common(_lineitem, _lineitem_l_returnflag, _lineitem_l_linestatus) and
                    ;;             l_discount(_lineitem, _lineitem_l_discount)
                    ;;         },
                    ;;         _v
                    ;;     )
                    (def :avg_disc
                        (
                            [_lineitem_l_returnflag::STRING
                             _lineitem_l_linestatus::STRING
                             _v::DECIMAL]

                            (exists [_sum_disc::DECIMAL _count_disc::DECIMAL]
                                (and
                                    (reduce
                                        ([a::DECIMAL b::DECIMAL c::DECIMAL] (+ a::DECIMAL b::DECIMAL c::DECIMAL))   ;; op
                                        ([_lineitem::UINT128 _lineitem_l_discount::DECIMAL]      ;; body
                                            (and
                                                (atom
                                                    :common
                                                    _lineitem::UINT128
                                                    _lineitem_l_returnflag::STRING
                                                    _lineitem_l_linestatus::STRING)
                                                (relatom
                                                    :lqp_l_discount
                                                    _lineitem::UINT128
                                                    _lineitem_l_discount::DECIMAL)))
                                        (terms _sum_disc::DECIMAL))
                                    (reduce
                                        ([a::DECIMAL b::DECIMAL c::DECIMAL] (+ a::DECIMAL b::DECIMAL c::DECIMAL))   ;; op
                                        ([_lineitem::UINT128 _lineitem_l_discount::DECIMAL _one::DECIMAL]      ;; body
                                            (and
                                                (atom
                                                    :common
                                                    _lineitem::UINT128
                                                    _lineitem_l_returnflag::STRING
                                                    _lineitem_l_linestatus::STRING)
                                                (relatom
                                                    :lqp_l_discount
                                                    _lineitem::UINT128
                                                    _lineitem_l_discount::DECIMAL)
                                                (cast DECIMAL 1 _one::DECIMAL)))
                                        (terms _count_disc::DECIMAL))
                                    (/ _sum_disc::DECIMAL _count_disc::DECIMAL _v::DECIMAL)))))

                    ;; def count_order(_lineitem_l_returnflag, _lineitem_l_linestatus, _v):
                    ;;     std::common::count(
                    ;;         {(_lineitem, _lineitem_l_quantity):
                    ;;             common(_lineitem, _lineitem_l_returnflag, _lineitem_l_linestatus) and
                    ;;         },
                    ;;         _v
                    ;;     )
                    (def :count_order
                        (
                            [_lineitem_l_returnflag::STRING
                             _lineitem_l_linestatus::STRING
                             _v::INT]

                            (reduce
                                ([a::INT b::INT c::INT] (+ a::INT b::INT c::INT))   ;; op
                                ([_lineitem::UINT128 _one::INT]                     ;; body
                                    (and
                                        (atom
                                            :common
                                            _lineitem::UINT128
                                            _lineitem_l_returnflag::STRING
                                            _lineitem_l_linestatus::STRING)
                                        (= _one::INT 1)))
                                (terms _v::INT)))))))

        (reads
            (output :sum_qty :sum_qty)
            (output :sum_base_price :sum_base_price)
            (output :sum_disc_price :sum_disc_price)
            (output :sum_charge :sum_charge)
            (output :avg_qty :avg_qty)
            (output :avg_base_price :avg_base_price)
            (output :avg_disc :avg_disc)
            (output :count_order :count_order))))
