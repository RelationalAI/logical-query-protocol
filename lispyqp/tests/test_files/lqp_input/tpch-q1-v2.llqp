(transaction
    (epoch
        (local_writes
            (define
                (fragment :f1
                    ;; def common(_lineitem):
                    ;;     exists((_lineitem_l_shipdate) |
                    ;;         LineItem(_lineitem) and
                    ;;         l_shipdate(_lineitem, _lineitem_l_shipdate) and
                    ;;         _lineitem_l_shipdate <= 1998-09-02
                    ;;     )

                    (def :common
                        (
                            [_lineitem::ENTITY]

                            (exists [_lineitem_l_shipdate::INT]
                                (and
                                    (relatom (sig :LineItem/ENTITY) _lineitem::ENTITY)
                                    (relatom (sig :lqp_l_shipdate/ENTITY/INT) _lineitem::ENTITY _lineitem_l_shipdate::INT)
                                    ;; 729723 is 1998-09-02 as a physical int
                                    (<= _lineitem_l_shipdate::INT 729723)
                                )
                            )
                        )
                    )

                    ;; def sum_qty(_lineitem_l_returnflag, _lineitem_l_linestatus, _v):
                    ;;     std::common::sum(
                    ;;         {(_lineitem, _lineitem_l_quantity):
                    ;;             common(_lineitem) and
                    ;;             l_returnflag(_lineitem, _lineitem_l_returnflag) and
                    ;;             l_linestatus(_lineitem, _lineitem_l_linestatus) and
                    ;;             l_quantity(_lineitem, _lineitem_l_quantity)
                    ;;         },
                    ;;         _v
                    ;;     )
                    (def :sum_qty
                        (
                            [
                                _lineitem_l_returnflag::STRING
                                _lineitem_l_linestatus::STRING
                                _v::INT
                            ]

                            (reduce
                                ([a::INT b::INT c::INT] (+ a::INT b::INT c::INT))   ;; op
                                ([_lineitem::ENTITY _lineitem_l_quantity::INT]      ;; body
                                    (and
                                        (atom
                                            :common
                                            _lineitem::ENTITY
                                        )
                                        (relatom
                                            (sig :lqp_l_returnflag/ENTITY/STRING)
                                            _lineitem::ENTITY
                                            _lineitem_l_returnflag::STRING
                                        )
                                        (relatom
                                            (sig :lqp_l_linestatus/ENTITY/STRING)
                                            _lineitem::ENTITY
                                            _lineitem_l_linestatus::STRING
                                        )
                                        (relatom
                                            (sig :lqp_l_quantity/ENTITY/INT)
                                            _lineitem::ENTITY
                                            _lineitem_l_quantity::INT
                                        )
                                    )
                                )
                                (terms _v::INT)                                     ;; result
                            )
                        )
                    )

                    ;; def sum_base_price(_lineitem_l_returnflag, _lineitem_l_linestatus, _v):
                    ;;     std::common::sum(
                    ;;         {(_lineitem, _lineitem_l_extendedprice):
                    ;;             common(_lineitem) and
                    ;;             l_returnflag(_lineitem, _lineitem_l_returnflag) and
                    ;;             l_linestatus(_lineitem, _lineitem_l_linestatus) and
                    ;;             l_extendedprice(_lineitem, _lineitem_l_extendedprice)
                    ;;         },
                    ;;         _v
                    ;;     )
                    (def :sum_base_price
                        (
                            [
                                _lineitem_l_returnflag::STRING
                                _lineitem_l_linestatus::STRING
                                _v::INT
                            ]

                            (reduce
                                ([a::INT b::INT c::INT] (+ a::INT b::INT c::INT))   ;; op
                                ([_lineitem::ENTITY _lineitem_l_extendedprice::INT] ;; body
                                    (and
                                        (atom
                                            :common
                                            _lineitem::ENTITY
                                        )
                                        (relatom
                                            (sig :lqp_l_returnflag/ENTITY/STRING)
                                            _lineitem::ENTITY
                                            _lineitem_l_returnflag::STRING
                                        )
                                        (relatom
                                            (sig :lqp_l_linestatus/ENTITY/STRING)
                                            _lineitem::ENTITY
                                            _lineitem_l_linestatus::STRING
                                        )
                                        (relatom
                                            (sig :lqp_l_extendedprice/ENTITY/INT)
                                            _lineitem::ENTITY
                                            _lineitem_l_extendedprice::INT
                                        )
                                    )
                                )
                                (terms _v::INT)                                     ;; result
                            )
                        )
                    )

                    ;; def sum_disc_price(_lineitem_l_returnflag, _lineitem_l_linestatus, _v):
                    ;;     std::common::sum(
                    ;;         {(_lineitem, _disc_price):
                    ;;             exists((_lineitem_l_discount, _lineitem_l_extendedprice) |
                    ;;                 common(_lineitem) and
                    ;;                 l_returnflag(_lineitem, _lineitem_l_returnflag) and
                    ;;                 l_linestatus(_lineitem, _lineitem_l_linestatus) and
                    ;;                 l_discount(_lineitem, _lineitem_l_discount) and
                    ;;                 l_extendedprice(_lineitem, _lineitem_l_extendedprice) and
                    ;;                 _disc_price = _lineitem_l_extendedprice * (1 - _lineitem_l_discount)
                    ;;             )
                    ;;         },
                    ;;         _v
                    ;;     )
                    (def :sum_disc_price
                        (
                            [
                                _lineitem_l_returnflag::STRING
                                _lineitem_l_linestatus::STRING
                                _v::INT
                            ]

                            (reduce
                                ([a::INT b::INT c::INT] (+ a::INT b::INT c::INT))   ;; op
                                ([_lineitem::ENTITY _disc_price::INT]              ;; body
                                    (exists
                                        [
                                            _lineitem_l_discount::INT
                                            _lineitem_l_extendedprice::INT
                                            _disc_perc::INT]

                                        (and
                                            (atom
                                                :common
                                                _lineitem::ENTITY)
                                            (relatom
                                                (sig :lqp_l_returnflag/ENTITY/STRING)
                                                _lineitem::ENTITY
                                                _lineitem_l_returnflag::STRING)
                                            (relatom
                                                (sig :lqp_l_linestatus/ENTITY/STRING)
                                                _lineitem::ENTITY
                                                _lineitem_l_linestatus::STRING)
                                            (relatom
                                                (sig :lqp_l_discount/ENTITY/INT)
                                                _lineitem::ENTITY
                                                _lineitem_l_discount::INT)
                                            (relatom
                                                (sig :lqp_l_extendedprice/ENTITY/INT)
                                                _lineitem::ENTITY
                                                _lineitem_l_extendedprice::INT)
                                            (primitive :rel_primitive_multiply_decimal 4 _lineitem_l_extendedprice::INT _disc_perc::INT _disc_price::INT)
                                            ;; 10000 is the physical int of 1 as a decimal(64, 4)
                                            (- 10000 _lineitem_l_discount::INT _disc_perc::INT))))
                                (terms _v::INT))))

                    ;; def sum_charge(_lineitem_l_returnflag, _lineitem_l_linestatus, _v):
                    ;;     std::common::sum(
                    ;;         {(_lineitem, _charge):
                    ;;             exists((_lineitem_l_extendedprice, _lineitem_l_discount, _lineitem_l_tax, _disc_perc, _disc_price) |
                    ;;                 common(_lineitem) and
                    ;;                 l_returnflag(_lineitem, _lineitem_l_returnflag) and
                    ;;                 l_linestatus(_lineitem, _lineitem_l_linestatus) and
                    ;;                 l_extendedprice(_lineitem, _lineitem_l_extendedprice) and
                    ;;                 l_discount(_lineitem, _lineitem_l_discount) and
                    ;;                 l_tax(_lineitem, _lineitem_l_tax) and
                    ;;                 _disc_price = _lineitem_l_extendedprice * (1 - _lineitem_l_discount) and
                    ;;                 _charge = _disc_price * (1 + l_tax)
                    ;;             )
                    ;;         },
                    ;;         _v
                    ;;     )
                    (def :sum_charge
                        (
                            [
                                _lineitem_l_returnflag::STRING
                                _lineitem_l_linestatus::STRING
                                _v::INT]

                            (reduce
                                ([a::INT b::INT c::INT] (+ a::INT b::INT c::INT))   ;; op
                                ([_lineitem::ENTITY _charge::INT]                  ;; body
                                    (exists
                                        [
                                            _lineitem_l_extendedprice::INT
                                            _lineitem_l_discount::INT
                                            _lineitem_l_tax::INT
                                            _disc_perc::INT
                                            _disc_price::INT
                                            _tax_rate::INT]

                                        (and
                                            (atom
                                                :common
                                                _lineitem::ENTITY)
                                            (relatom
                                                (sig :lqp_l_returnflag/ENTITY/STRING)
                                                _lineitem::ENTITY
                                                _lineitem_l_returnflag::STRING)
                                            (relatom
                                                (sig :lqp_l_linestatus/ENTITY/STRING)
                                                _lineitem::ENTITY
                                                _lineitem_l_linestatus::STRING)
                                            (relatom
                                                (sig :lqp_l_extendedprice/ENTITY/INT)
                                                _lineitem::ENTITY
                                                _lineitem_l_extendedprice::INT)
                                            (relatom
                                                (sig :lqp_l_discount/ENTITY/INT)
                                                _lineitem::ENTITY
                                                _lineitem_l_discount::INT)
                                            (relatom
                                                (sig :lqp_l_tax/ENTITY/INT)
                                                _lineitem::ENTITY
                                                _lineitem_l_tax::INT)
                                            (primitive :rel_primitive_multiply_decimal 4 _lineitem_l_extendedprice::INT _disc_perc::INT _disc_price::INT)
                                            (- 10000 _lineitem_l_discount::INT _disc_perc::INT)
                                            (primitive :rel_primitive_multiply_decimal 4 _disc_price::INT _tax_rate::INT _charge::INT)
                                            (+ 10000 _lineitem_l_tax::INT _tax_rate::INT))))
                                (terms _v::INT))))

                    ;; def avg_qty(_lineitem_l_returnflag, _lineitem_l_linestatus, _v):
                    ;;     std::common::mean(
                    ;;         {(_lineitem, _lineitem_l_quantity):
                    ;;             common(_lineitem) and
                    ;;             l_returnflag(_lineitem, _lineitem_l_returnflag) and
                    ;;             l_linestatus(_lineitem, _lineitem_l_linestatus) and
                    ;;             l_quantity(_lineitem, _lineitem_l_quantity)
                    ;;         },
                    ;;         _v
                    ;;     )
                    (def :avg_qty
                        (
                            [
                                _lineitem_l_returnflag::STRING
                                _lineitem_l_linestatus::STRING
                                _v::INT]

                            (exists [_sum_qty::INT _count_qty::INT]
                                (and
                                    (atom :sum_qty _lineitem_l_returnflag::STRING _lineitem_l_linestatus::STRING _sum_qty::INT)
                                    (reduce
                                        ([a::INT b::INT c::INT] (+ a::INT b::INT c::INT))   ;; op
                                        ([_lineitem::ENTITY _lineitem_l_quantity::INT _one::INT]      ;; body
                                            (and
                                                (atom
                                                    :common
                                                    _lineitem::ENTITY)
                                                (relatom
                                                    (sig :lqp_l_returnflag/ENTITY/STRING)
                                                    _lineitem::ENTITY
                                                    _lineitem_l_returnflag::STRING)
                                                (relatom
                                                    (sig :lqp_l_linestatus/ENTITY/STRING)
                                                    _lineitem::ENTITY
                                                    _lineitem_l_linestatus::STRING)
                                                (relatom
                                                    (sig :lqp_l_quantity/ENTITY/INT)
                                                    _lineitem::ENTITY
                                                    _lineitem_l_quantity::INT)
                                                (= _one::INT 10000)))
                                        (terms _count_qty::INT))
                                    (primitive :rel_primitive_divide_decimal 4 _sum_qty::INT _count_qty::INT _v::INT)))))

                    ;; def avg_base_price(_lineitem_l_returnflag, _lineitem_l_linestatus, _v):
                    ;;     std::common::mean(
                    ;;         {(_lineitem, _lineitem_l_extendedprice):
                    ;;             common(_lineitem) and
                    ;;             l_returnflag(_lineitem, _lineitem_l_returnflag) and
                    ;;             l_linestatus(_lineitem, _lineitem_l_linestatus) and
                    ;;             l_extendedprice(_lineitem, _lineitem_l_extendedprice)
                    ;;         },
                    ;;         _v
                    ;;     )
                    (def :avg_base_price
                        (
                            [
                                _lineitem_l_returnflag::STRING
                                _lineitem_l_linestatus::STRING
                                _v::INT]

                            (exists [_sum_base_price::INT _count_base_price::INT]
                                (and
                                    (atom :sum_base_price _lineitem_l_returnflag::STRING _lineitem_l_linestatus::STRING _sum_base_price::INT)
                                    (reduce
                                        ([a::INT b::INT c::INT] (+ a::INT b::INT c::INT))   ;; op
                                        ([_lineitem::ENTITY _lineitem_l_extendedprice::INT _one::INT] ;; body
                                            (and
                                                (atom
                                                    :common
                                                    _lineitem::ENTITY)
                                                (relatom
                                                    (sig :lqp_l_returnflag/ENTITY/STRING)
                                                    _lineitem::ENTITY
                                                    _lineitem_l_returnflag::STRING)
                                                (relatom
                                                    (sig :lqp_l_linestatus/ENTITY/STRING)
                                                    _lineitem::ENTITY
                                                    _lineitem_l_linestatus::STRING)
                                                (relatom
                                                    (sig :lqp_l_extendedprice/ENTITY/INT)
                                                    _lineitem::ENTITY
                                                    _lineitem_l_extendedprice::INT)
                                                (= _one::INT 10000)))
                                        (terms _count_base_price::INT))
                                    (primitive :rel_primitive_divide_decimal 4 _sum_base_price::INT _count_base_price::INT _v::INT)))))

                    ;; def avg_disc(_lineitem_l_returnflag, _lineitem_l_linestatus, _v):
                    ;;     std::common::mean(
                    ;;         {(_lineitem, _lineitem_l_discount):
                    ;;             common(_lineitem) and
                    ;;             l_returnflag(_lineitem, _lineitem_l_returnflag) and
                    ;;             l_linestatus(_lineitem, _lineitem_l_linestatus) and
                    ;;             l_discount(_lineitem, _lineitem_l_discount)
                    ;;         },
                    ;;         _v
                    ;;     )
                    (def :avg_disc
                        (
                            [
                                _lineitem_l_returnflag::STRING
                                _lineitem_l_linestatus::STRING
                                _v::INT]

                            (exists [_sum_disc::INT _count_disc::INT]
                                (and
                                    (reduce
                                        ([a::INT b::INT c::INT] (+ a::INT b::INT c::INT))   ;; op
                                        ([_lineitem::ENTITY _lineitem_l_discount::INT]      ;; body
                                            (and
                                                (atom
                                                    :common
                                                    _lineitem::ENTITY)
                                                (relatom
                                                    (sig :lqp_l_returnflag/ENTITY/STRING)
                                                    _lineitem::ENTITY
                                                    _lineitem_l_returnflag::STRING)
                                                (relatom
                                                    (sig :lqp_l_linestatus/ENTITY/STRING)
                                                    _lineitem::ENTITY
                                                    _lineitem_l_linestatus::STRING)
                                                (relatom
                                                    (sig :lqp_l_discount/ENTITY/INT)
                                                    _lineitem::ENTITY
                                                    _lineitem_l_discount::INT)))
                                        (terms _sum_disc::INT))
                                    (reduce
                                        ([a::INT b::INT c::INT] (+ a::INT b::INT c::INT))   ;; op
                                        ([_lineitem::ENTITY _lineitem_l_discount::INT _one::INT]      ;; body
                                            (and
                                                (atom
                                                    :common
                                                    _lineitem::ENTITY)
                                                (relatom
                                                    (sig :lqp_l_returnflag/ENTITY/STRING)
                                                    _lineitem::ENTITY
                                                    _lineitem_l_returnflag::STRING)
                                                (relatom
                                                    (sig :lqp_l_linestatus/ENTITY/STRING)
                                                    _lineitem::ENTITY
                                                    _lineitem_l_linestatus::STRING)
                                                (relatom
                                                    (sig :lqp_l_discount/ENTITY/INT)
                                                    _lineitem::ENTITY
                                                    _lineitem_l_discount::INT)
                                                (= _one::INT 10000)))
                                        (terms _count_disc::INT))
                                    (primitive :rel_primitive_divide_decimal 4 _sum_disc::INT _count_disc::INT _v::INT)))))

                    ;; def count_order(_lineitem_l_returnflag, _lineitem_l_linestatus, _v):
                    ;;     std::common::count(
                    ;;         {(_lineitem, _lineitem_l_quantity):
                    ;;             common(_lineitem) and
                    ;;             l_returnflag(_lineitem, _lineitem_l_returnflag) and
                    ;;             l_linestatus(_lineitem, _lineitem_l_linestatus) and
                    ;;         },
                    ;;         _v
                    ;;     )
                    (def :count_order
                    (
                        [
                            _lineitem_l_returnflag::STRING
                            _lineitem_l_linestatus::STRING
                            _v::INT]

                        (reduce
                            ([a::INT b::INT c::INT] (+ a::INT b::INT c::INT))   ;; op
                            ([_lineitem::ENTITY _one::INT]                     ;; body
                                (and
                                    (atom
                                        :common
                                        _lineitem::ENTITY)
                                    (relatom
                                        (sig :lqp_l_returnflag/ENTITY/STRING)
                                        _lineitem::ENTITY
                                        _lineitem_l_returnflag::STRING)
                                    (relatom
                                        (sig :lqp_l_linestatus/ENTITY/STRING)
                                        _lineitem::ENTITY
                                        _lineitem_l_linestatus::STRING)
                                    (= _one::INT 1)))
                            (terms _v::INT)))))))

        (reads
            (output :sum_qty :sum_qty)
            (output :sum_base_price :sum_base_price)
            (output :sum_disc_price :sum_disc_price)
            (output :sum_charge :sum_charge)
            (output :avg_qty :avg_qty)
            (output :avg_base_price :avg_base_price)
            (output :avg_disc :avg_disc)
            (output :count_order :count_order))))
