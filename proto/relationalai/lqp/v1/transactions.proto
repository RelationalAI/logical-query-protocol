syntax = "proto3";

option go_package = "logical-query-protocol/lqp/v1";

package relationalai.lqp.v1;

import "relationalai/lqp/v1/fragments.proto";
import "relationalai/lqp/v1/logic.proto";

message Transaction {
  repeated Epoch epochs = 1;
  Configure configure = 2;
  optional Sync sync = 3;  
}

message Configure {
  int64 semantics_version = 1;
  IVMConfig ivm_config = 2;
} 

message IVMConfig {
  MaintenanceLevel level = 1;
}

enum MaintenanceLevel {
  MAINTENANCE_LEVEL_UNSPECIFIED = 0;
  MAINTENANCE_LEVEL_OFF = 1;
  MAINTENANCE_LEVEL_AUTO = 2;
  MAINTENANCE_LEVEL_ALL = 3;
}

message Sync {
  repeated FragmentId fragments = 1;
}

message Epoch {
  repeated Write writes = 1;
  repeated Read reads = 2;
}

//
// Write operations
//

message Write {
  reserved 4; // Sync is now at transaction level
  oneof write_type {
    Define define = 1;
    Undefine undefine = 2;
    Context context = 3;
    Snapshot snapshot = 5;
  }
}

message Define {
  Fragment fragment = 1;
}

message Undefine {
  FragmentId fragment_id = 1;
}

message Context {
  repeated RelationId relations = 1;
}

// Demand the source IDB, take an immutable snapshot, and turn it into an EDB under the
// given path (specified as a sequence of strings, see RelEDB).
message Snapshot {
  repeated string destination_path = 1;
  RelationId source_relation = 2;
}

//
// Export config
//

message ExportCSVConfig {
  string path = 1;
  repeated ExportCSVColumn data_columns = 2;

  optional int64 partition_size = 3;
  optional string compression = 4;
  optional bool             syntax_header_row = 5;
  optional string           syntax_missing_string = 6;
  optional string           syntax_delim = 7;
  optional string           syntax_quotechar = 8;
  optional string           syntax_escapechar = 9;

  // TODO: support data integration options, e.g., private tokens for private buckets etc.
}

message ExportCSVColumn {
  string column_name = 1;
  RelationId column_data = 2;
}

//
// Read operations
//

message Read {
  oneof read_type {
    Demand demand = 1;
    Output output = 2;
    WhatIf what_if = 3;
    Abort abort = 4;
    Export export = 5;
  }
}

message Demand {
  RelationId relation_id = 1;
}

message Output {
  string name = 1;
  RelationId relation_id = 2;
}

message Export {
  oneof export_config {
    ExportCSVConfig csv_config = 1;

    // TODO: support JSON export
  }
}

message WhatIf {
  string branch = 1;
  Epoch epoch = 2;
}

message Abort {
  string name = 1;
  RelationId relation_id = 2;
}
