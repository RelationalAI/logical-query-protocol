syntax = "proto3";

package relationalai.lqp.v1;

import "relationalai/lqp/v1/fragments.proto";
import "relationalai/lqp/v1/logic.proto";

// Transaction and Epoch
message Transaction {
  repeated Epoch epochs = 1;
}

message Epoch {
  repeated Write persistent_writes = 1;
  repeated Write local_writes = 2;
  repeated Read reads = 3;
}

//
// Write operations
//

message Write {
  oneof write_type {
    Define define = 1;
    Undefine undefine = 2;
    Context context = 3;
  }
}

message Define {
  Fragment fragment = 1;
}

message Undefine {
  FragmentId fragment_id = 1;
}

message Context {
  repeated RelationId relations = 1;
}

//
// Export config
//

message ExportConfig {
  oneof export_config {
    ExportCSVConfig csv_config = 1;

    // TODO: support JSON export
  }
}

message ExportCSVConfig {
  repeated ExportCSVColumn data_columns = 1;
  string path = 2;
  optional int64 partition_size = 3;
  optional string compression = 4;

  optional bool             syntax_header_row = 5;
  optional string           syntax_missing_string = 6;
  optional string           syntax_delim = 7;
  optional string           syntax_quotechar = 8;
  optional string           syntax_escapechar = 9;

  // TODO: support integration
}

message ExportCSVColumn {
  int64 column_number = 1;
  string column_name = 2;
  RelationId column_data = 3;
}

//
// Read operations
//

message Read {
  oneof read_type {
    Demand demand = 1;
    Output output = 2;
    WhatIf what_if = 3;
    Abort abort = 4;
    Export export = 5;
  }
}

message Demand {
  RelationId relation_id = 1;
}

message Output {
  string name = 1;
  RelationId relation_id = 2;
}

message Export {
  ExportConfig config = 1;
}

message WhatIf {
  string branch = 1;
  Epoch epoch = 2;
}

message Abort {
  string name = 1;
  RelationId relation_id = 2;
}
